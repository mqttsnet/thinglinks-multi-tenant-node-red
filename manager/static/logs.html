<html lang="en">
<head>
	<style>
  html, body { min-height: 100vh; margin: 0; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
  .loglist-container { width: 80%; margin: 1rem auto 2rem; padding: 8rem 2rem; flex: 1; overflow: hidden; min-height: 0; }
  .loglist { height: 100%; overflow-y: auto; box-sizing: border-box; }
	</style>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title></title>
    <script src="js/config.js"></script>
    <link rel="stylesheet" href="picnic.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body> <nav>
          <a href="/" class="brand"><span>ThingLinks Multi-Tenant Node-RED</span></a>
          <div class="menu" style="margin: 1rem 0;">
              <a href="new.html" class="button">Add New Instance</a>
              <a href="list.html" class="button">Manage Instances</a>
              <a href="logs.html" class="button" disabled>View Instance Logs</a>
          </div>
          <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap; margin: 1rem 0 0 0; padding: 1.5rem 1.5rem 0; width: 100%; background: #f5f5f5; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex-shrink: 0;">
              <select name="container" id="container" style="flex: 1; min-width: 200px;"></select>
              <button onclick="connect()" id="connect" class="button">Connect</button>
              <button onclick="clearLog()" class="button">Clear</button>
              <button onclick="disconnect()" id="disconnect" disabled="" class="button">Disconnect</button>
          </div>

    </nav>
    <div class="loglist-container">
    <section class="container mt-1 loglist" style="padding: 1rem; background: #f8f9fa; border-radius: 4px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); height: 100%; box-sizing: border-box;">
  	    <div style="font-family: monospace, monospace; font-size: small;" id="log"></div>
        </section>
    </div>
        <script>
        // 设置页面标题
        setPageTitle('logs');
        // 渲染页脚
        renderFooter();
    </script>
</body>
<script>

populate();

function populate(){
	var xhr = new XMLHttpRequest();

	xhr.onload = function() {
		const response = JSON.parse(xhr.responseText);

		var containers = response.containers;
		for (const container in containers) {
			var instanceName = containers[container].Names[0].substring(1);
			var option = document.createElement("option");
			option.setAttribute("value", instanceName);
			option.innerHTML = instanceName;
			document.getElementById("container").appendChild(option);
		}
	}

	xhr.open("GET", "/instance");
	xhr.setRequestHeader('Content-Type', 'application/json');
	xhr.send()
}

var ws = null;

function connect() {
	clearLog();
	if (ws){
		disconnect();
	}
	var selected = document.getElementById("container");
    if (location.protocol === 'https:') {
		ws = new WebSocket(`wss://${location.host}` + "/" + selected.options[selected.selectedIndex].value);
	} else {
		ws = new WebSocket(`ws://${location.host}` + "/" + selected.options[selected.selectedIndex].value);
	}
	var log = document.getElementById('log');
    ws.onmessage =  function(event) {
        var line = event.data;
        // console.log(line);
        log.innerText = log.innerText + line;
    };
	document.getElementById('connect').setAttribute("disabled", "true");
	document.getElementById('disconnect').removeAttribute("disabled");
}

function disconnect() {
	if (ws) {
		ws.close();
		delete ws;
	}
	document.getElementById('connect').removeAttribute("disabled");
	document.getElementById('disconnect').setAttribute("disabled", "true");
}

function clearLog() {
	document.getElementById('log').innerHTML = "";
}
</script>
</html>