<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script src="js/config.js"></script>
    <link rel="stylesheet" href="picnic.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<nav>
    <a href="/" class="brand"><span>ThingLinks Multi-Tenant Node-RED</span></a>
    <div class="menu">
        <a href="new.html" class="button" disabled>Add New Instance</a>
        <a href="list.html" class="button">Manage Instances</a>
        <a href="logs.html" class="button">View Instance Logs</a>
    </div>
</nav>
<section class="container mt-1" style="min-height: calc(100vh - 200px);">
    <div class="form">
        <label class="form" for="appName">Instance Name:</label>
        <input class="form" id="appName" type="text" required pattern="^[a-zA-Z0-9]+$" title="只能包含英文或数字">
        <div class="error-message" id="appNameError"></div>
        <label class="form" for="email">Owner Email address:</label>
        <input class="form" id="email" type="email" required pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$">
        <div class="error-message" id="emailError"></div>
        <label class="form" for="userid">Admin UserID:</label>
        <input class="form" id="userid" type="text" required minlength="3">
        <div class="error-message" id="useridError"></div>
        <label class="form" for="password">Admin Password:</label>
        <input class="form" id="password" type="password" required minlength="8">
        <div class="error-message" id="passwordError"></div>
        <label class="form" for="confirm-password">Confirm Admin Password:</label>
        <input class="form" id="confirm-password" type="password" required>
        <div class="error-message" id="confirmPasswordError"></div>
        <button id="submit" onclick="submit()" disabled>Submit</button>
    </div>
    <div id="output"></div>
    <div id="err"></div>
</section>

<style>
    .error-message {
        color: #e74c3c;
        font-size: 0.875rem;
        margin-top: -0.8rem;
        margin-bottom: 1rem;
        height: 1rem;
    }

    input:invalid:not(:focus):not(:placeholder-shown) {
        border: 1px solid #e74c3c;
    }

    input:valid {
        border: 1px solid #2ecc71;
    }
</style>
<script type="text/javascript">
    // 实时验证表单字段
    function validateField(fieldId, errorId, validationFn) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(errorId);
        const isValid = validationFn(field);

        if (!isValid) {
            errorElement.textContent = field.dataset.errorMessage;
            field.classList.add('invalid');
        } else {
            errorElement.textContent = '';
            field.classList.remove('invalid');
        }

        updateSubmitButton();
    }

    // 更新提交按钮状态
    function updateSubmitButton() {
        const allFieldsValid = [
            document.getElementById('appName').checkValidity(),
            document.getElementById('email').checkValidity(),
            document.getElementById('userid').checkValidity(),
            document.getElementById('password').checkValidity(),
            document.getElementById('confirm-password').checkValidity(),
            document.getElementById('password').value === document.getElementById('confirm-password').value
        ].every(Boolean);

        document.getElementById('submit').disabled = !allFieldsValid;
    }

    // 添加实时验证事件监听
    document.addEventListener('DOMContentLoaded', function () {
        const appName = document.getElementById('appName');
        appName.dataset.errorMessage = '实例名称只能包含英文或数字';
        appName.addEventListener('input', () => validateField('appName', 'appNameError', (field) => field.checkValidity()));

        const email = document.getElementById('email');
        email.dataset.errorMessage = '请输入有效的邮箱地址';
        email.addEventListener('input', () => validateField('email', 'emailError', (field) => field.checkValidity()));

        const userid = document.getElementById('userid');
        userid.dataset.errorMessage = '管理员用户名至少3个字符';
        userid.addEventListener('input', () => validateField('userid', 'useridError', (field) => field.checkValidity()));

        const password = document.getElementById('password');
        password.dataset.errorMessage = '密码至少8个字符';
        password.addEventListener('input', () => {
            validateField('password', 'passwordError', (field) => field.checkValidity());
            validateField('confirm-password', 'confirmPasswordError', (field) => field.value === password.value);
        });

        const confirmPassword = document.getElementById('confirm-password');
        confirmPassword.dataset.errorMessage = '两次密码输入不一致';
        confirmPassword.addEventListener('input', () => validateField('confirm-password', 'confirmPasswordError', (field) => field.value === password.value));

        updateSubmitButton();
    });

    // 初始化字段错误消息
    function submit() {

        // 客户端验证已在实时验证中处理，此处仅作为备份
        if (!document.getElementById("submit").disabled) {
            document.getElementById("output").innerHTML = "提交请求中...";
        } else {
            document.getElementById("output").innerHTML = "请完善并修正表单中的错误后再提交";
            return;
        }

        var payload = {
            appname: document.getElementById("appName").value,
            email: document.getElementById("email").value,
            userid: document.getElementById("userid").value,
            password: document.getElementById("password").value
        }

        var xhr = new XMLHttpRequest();

        xhr.onload = function () {
            try {
                // 检查HTTP状态码
                if (xhr.status >= 200 && xhr.status < 300) {
                    // 验证响应内容类型
                    const contentType = xhr.getResponseHeader('Content-Type');
                    if (contentType && contentType.includes('application/json')) {
                        const response = JSON.parse(xhr.responseText);
                        if (xhr.status === 201) {
                            var link = document.createElement('a');
                            link.setAttribute("href", response.url);
                            link.innerHTML = response.url;
                            setTimeout(function () {
                                document.getElementById("output").innerHTML = "";
                                document.getElementById("output").appendChild(link);
                            }, 5000);
                            document.getElementById("output").innerHTML = "创建中，等待实例启动...";
                        } else {
                            document.getElementById("output").innerHTML = response.msg || "操作成功";
                        }
                    } else {
                        document.getElementById("output").innerHTML = "错误：服务器返回非JSON响应";
                        console.error("响应内容:", xhr.responseText);
                    }
                } else if (xhr.status === 404) {
                    document.getElementById("output").innerHTML = "错误：后端服务未找到，请确保manager服务已启动在3000端口";
                } else if (xhr.status === 500) {
                    document.getElementById("output").innerHTML = "错误：服务器内部错误，请稍后重试";
                } else {
                    document.getElementById("output").innerHTML = "请求失败 (状态码: " + xhr.status + "，响应内容: " + xhr.responseText + ")";
                }
            } catch (e) {
                if (e instanceof SyntaxError) {
                    document.getElementById("output").innerHTML = "错误：服务器返回无效JSON响应";
                    console.error("JSON解析错误:", e, "响应内容:", xhr.responseText);
                } else {
                    document.getElementById("output").innerHTML = "处理请求时发生错误: " + e.message;
                }
            }
        }

        // 使用绝对路径指向正确的后端服务端口
        xhr.open("POST", "/instance");
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(payload))
    }
</script>
<script>
    // 设置页面标题
    setPageTitle('new');
    // 渲染页脚
    renderFooter();
</script>
</body>
</html>